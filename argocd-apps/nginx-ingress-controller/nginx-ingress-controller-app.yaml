apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nginx-ingress-controller
  namespace: argocd  # Assumes ArgoCD installed in 'argocd' namespace
  annotations:
    argocd.argoproj.io/sync-wave: "1"  
  # Labels: e.g., app.kubernetes.io/part-of: ingress
spec:
  project: default  # Use dedicated project for isolation in production
  source:
    repoURL: https://kubernetes.github.io/ingress-nginx  # Official Helm repo
    chart: ingress-nginx
    targetRevision: 4.13.3  # Latest stable version; pin for production
    helm:
      releaseName: nginx-ingress-controller
      values: |
        controller:
          replicaCount: 2
          service:
            type: LoadBalancer
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
              service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
          resources:
            requests:
              cpu: 100m
              memory: 90Mi
            limits:
              cpu: 200m
              memory: 180Mi
          config:
            use-forwarded-headers: "true"
            compute-full-forwarded-for: "true"
            use-proxy-protocol: "false"
            ssl-redirect: "true"
            log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time $upstream_response_time $pipe $upstream_addr'
          configurationSnippet: |
            if ($request_uri ~* "/.well-known/acme-challenge/") {
              set $ssl_redirect 0;
            }
          metrics:
            enabled: false
            serviceMonitor:
              enabled: false
          admissionWebhooks:
            enabled: true
          podSecurityContext:
            runAsUser: 101
            fsGroup: 101
          securityContext:
            allowPrivilegeEscalation: false
          rbac:
            create: true
            scope: cluster
  destination:
    server: https://kubernetes.default.svc  # In-cluster
    namespace: nginx-ingress  # Dedicated namespace
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
    # IgnoreDifferences for resources like LoadBalancer IP if dynamic
  # info: { url: http://nginx-ingress-controller-nginx-ingress-controller.nginx-ingress.svc.cluster.local }  # Optional
  # Assumptions: AWS EKS; prerequisites: ClusterRoleBindings for webhook if enabled